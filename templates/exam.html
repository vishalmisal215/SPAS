{% extends "base.html" %}

{% block content %}
<section class="hero hero-small">
    <h1>Online Practical Exam</h1>
    <p>Answer carefully - you cannot come back once submitted</p>
</section>

<div id="timer" class="timer" data-remaining="{{ remaining }}">Time Left:</div>
<div id="tab-warning" class="warning"></div>

<div style="max-width: 900px; margin: 0 auto 20px auto; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px;">
    <strong>Important Reminders:</strong>
    <ul style="margin: 10px 0 0 20px; line-height: 1.6;">
        <li>Do not switch tabs or windows</li>
        <li>Copy-paste is disabled for exam integrity</li>
        <li>Answer all questions you can</li>
        <li>Submit only when you're sure</li>
        <li>Back button is disabled during the exam</li>
    </ul>
</div>

<form id="examForm" class="exam-form no-select" method="POST" action="{{ url_for('submit_exam') }}">

    {# âœ… FIX 1: Hidden field â€” sends practical_name to submit_exam route #}
    <input type="hidden" name="practical_name" value="{{ practical_name }}">

    {% for q in questions %}
    <div class="question-block card">
        <p><strong>Q{{ loop.index }}.</strong> {{ q.question }}</p>
        {% for key, text in q.options.items() %}
        <label class="option-label">
            <input type="radio" name="answer_{{ q.id }}" value="{{ key }}">
            <span class="option-tag">{{ key }}</span> {{ text }}
        </label>
        {% endfor %}
    </div>
    {% endfor %}

    <button type="submit" class="submit-btn" id="submitBtn">Submit Exam</button>
</form>

<script>
    let examSubmitted = false;

    /* âœ… FIX 2: startTimer â€” calls autoSubmitExam() instead of redirecting */
    function startTimer(seconds) {
        const timerDiv = document.getElementById("timer");

        function tick() {
            if (seconds <= 0) {
                timerDiv.textContent = "Time Left: 00:00";
                autoSubmitExam();
                return;
            }
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            timerDiv.textContent = "Time Left: " + String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");

            if (seconds <= 300) {   /* red under 5 min */
                timerDiv.style.color = "#c62828";
                timerDiv.style.fontWeight = "bold";
            }
            seconds--;
            setTimeout(tick, 1000);
        }
        tick();
    }

    /* âœ… FIX 3: autoSubmitExam submits the FORM (POST) â€” not a page redirect */
    function autoSubmitExam() {
        if (examSubmitted) return;
        examSubmitted = true;
        window.onbeforeunload = null;
        alert("â° Time is up! Your exam is being submitted now.");
        document.getElementById("examForm").submit();
    }

    /* ---- Init on DOM ready ---- */
    document.addEventListener("DOMContentLoaded", function () {
        const timerDiv = document.getElementById("timer");
        const remaining = parseInt(timerDiv.getAttribute("data-remaining"));
        startTimer(remaining);
        initTabMonitor();
    });

    /* âœ… FIX 4: Prevent double-submit (button spam / timer + manual submit) */
    document.getElementById("examForm").addEventListener("submit", function (e) {
        if (examSubmitted) {
            e.preventDefault();
            return;
        }
        examSubmitted = true;
        window.onbeforeunload = null;
        const btn = document.getElementById("submitBtn");
        btn.disabled = true;
        btn.textContent = "Submitting...";
    });

    /* ---- Tab monitor ---- */
    function initTabMonitor() {
        let tabSwitches = 0;
        document.addEventListener("visibilitychange", function () {
            if (document.hidden && !examSubmitted) {
                tabSwitches++;
                const warn = document.getElementById("tab-warning");
                if (warn) {
                    warn.textContent = "âš ï¸ Warning: Tab switching detected (" + tabSwitches + " time(s))!";
                    warn.style.display = "block";
                }
            }
        });
    }

    /* ---- Back button disable ---- */
    (function () {
        history.pushState(null, null, window.location.href);
        history.pushState(null, null, window.location.href);

        window.addEventListener("popstate", function () {
            history.pushState(null, null, window.location.href);
            showBackWarning();
        });

        window.onbeforeunload = function (e) {
            if (!examSubmitted) {
                const msg = "Your exam is in progress! Leaving this page will not submit your answers.";
                e.returnValue = msg;
                return msg;
            }
        };

        function showBackWarning() {
            const existing = document.getElementById("back-block-warning");
            if (existing) {
                existing.style.display = "flex";
                clearTimeout(existing._timer);
                existing._timer = setTimeout(() => { existing.style.display = "none"; }, 3000);
                return;
            }
            const banner = document.createElement("div");
            banner.id = "back-block-warning";
            banner.style.cssText = `
                position:fixed; top:80px; left:50%; transform:translateX(-50%);
                background:#c62828; color:#fff; padding:14px 28px;
                border-radius:10px; font-size:15px; font-weight:600;
                z-index:999999; box-shadow:0 4px 20px rgba(198,40,40,.5);
                display:flex; align-items:center; gap:10px;
                animation:slideDown .3s ease;
            `;
            banner.innerHTML = "ðŸš« Back button is disabled during the exam!";
            document.body.appendChild(banner);
            banner._timer = setTimeout(() => { banner.style.display = "none"; }, 3000);
        }
    })();

    /* ---- Block Alt+Left & Backspace navigation ---- */
    document.addEventListener("keydown", function (e) {
        if (e.altKey && e.key === "ArrowLeft") {
            e.preventDefault();
            history.pushState(null, null, window.location.href);
        }
        if (e.key === "Backspace") {
            const tag = document.activeElement.tagName.toLowerCase();
            if (tag !== "input" && tag !== "textarea") e.preventDefault();
        }
    });
</script>

<style>
@keyframes slideDown {
    from { top: 60px; opacity: 0; }
    to   { top: 80px; opacity: 1; }
}
</style>

{% endblock %}
